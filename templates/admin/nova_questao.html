<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% if questao %}Editar Questão{% else %}Nova Questão{% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- TinyMCE API -->
    <script src="https://cdn.tiny.cloud/1/xew4b0q0sgfpje8cr43zzu6m2h7jsjm0vezet5xs2exuy781/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
      tinymce.init({
        selector: '#enunciado',
        height: 300,
        plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
        menubar: false
      });
    </script>

    <style>
        :root {
            --bg: #0e1326;
            --panel: #121a2f;
            --panel-2: #10182b;
            --text: #e2e8f0;
            --muted: #9aa4b0;
            --border: #24304f;
            --accent: #3b82f6;
            --accent-2: #22c55e;
            --danger: #ef4444;
            --hover: #223058;
        }
        body { background: var(--bg); font-family: 'Segoe UI', system-ui, sans-serif; color: var(--text); }
        .nav { background: #0b1220; color: var(--text); padding: 12px 20px; display: flex; gap: 12px; align-items: center; border-radius: 10px; margin: 16px; }
        .nav a { color: var(--text); text-decoration: none; padding: 6px 10px; border-radius: 6px; }
        .nav a:hover { background: var(--hover); }
        .form-container { max-width: 950px; margin: 20px auto 40px; background-color: var(--panel); padding: 28px; border-radius: 12px; border: 1px solid var(--border); }
        h1 { margin: 0 0 16px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        label { font-weight: 600; display: block; margin-top: 14px; }
        input[type="text"], select, textarea { width: 100%; padding: 10px; margin-top: 6px; font-size: 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--panel-2); color: var(--text); }
        .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }
        .row { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; }
        .alt-label { width: 28px; text-align: center; font-weight: 600; color: var(--muted); }
        .radio { display: inline-flex; align-items: center; gap: 6px; color: var(--muted); }
        .actions { display: flex; gap: 10px; margin-top: 20px; }
        button[type="submit"] { background-color: var(--accent-2); color: white; padding: 12px 20px; border: none; font-size: 16px; border-radius: 8px; cursor: pointer; }
        .btn-secondary { background: var(--hover); color: var(--text); border: 1px solid var(--border); padding: 12px 16px; border-radius: 8px; cursor: pointer; }
        .audio-preview { margin-top: 8px; }
        .danger { color: var(--danger); }
    </style>

    <script>
        function toggleAudioField() {
            const tipo = document.getElementById('tipo').value;
            const audioDiv = document.getElementById('audio_field');
            audioDiv.style.display = tipo === 'listening' ? 'block' : 'none';
        }
        function updateAudioPreview() {
            const input = document.querySelector('input[name="audio"]');
            const player = document.getElementById('audio_preview');
            const url = (input && input.value || '').trim();
            if (url) {
                player.src = url;
                player.style.display = 'block';
            } else {
                player.pause();
                player.removeAttribute('src');
                player.style.display = 'none';
            }
        }
        function validateForm(e) {
            const tipo = document.getElementById('tipo').value;
            const audio = (document.querySelector('input[name="audio"]').value || '').trim();
            const A = (document.querySelector('input[name="A"]').value || '').trim();
            const B = (document.querySelector('input[name="B"]').value || '').trim();
            const C = (document.querySelector('input[name="C"]').value || '').trim();
            const D = (document.querySelector('input[name="D"]').value || '').trim();
            const resposta = document.querySelector('input[name="resposta"]:checked');
            const errors = [];
            if (tipo === 'listening' && !audio) {
                errors.push('Para Listening, informe o link do áudio.');
            }
            const set = new Set([A,B,C,D].filter(x => x));
            if (set.size < 4) {
                errors.push('Alternativas A, B, C e D devem ser distintas e preenchidas.');
            }
            if (!resposta) {
                errors.push('Selecione a resposta correta.');
            }
            const box = document.getElementById('errors_box');
            box.innerHTML = '';
            if (errors.length) {
                e.preventDefault();
                errors.forEach(msg => {
                    const li = document.createElement('li');
                    li.textContent = msg;
                    box.appendChild(li);
                });
                box.parentElement.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const audioInput = document.querySelector('input[name="audio"]');
            if (audioInput) audioInput.addEventListener('input', updateAudioPreview);
            const form = document.querySelector('form');
            form.addEventListener('submit', validateForm);
        });
    </script>
</head>
<body onload="toggleAudioField()">
    <div class="nav">
        <strong>Admin</strong>
        <a href="{{ url_for('admin.dashboard') }}">Dashboard</a>
        <a href="{{ url_for('admin.listar_questoes') }}">Questões</a>
        <a href="{{ url_for('admin.nova_questao') }}">Nova Questão</a>
        <a href="{{ url_for('admin.logout') }}">Sair</a>
    </div>
    <div class="form-container">
        <h1>{% if questao %}✏️ Editar Questão{% else %}➕ Nova Questão{% endif %}</h1>
        <div style="display:none;background:#1b243e;padding:12px;border-radius:10px;border:1px solid var(--border);margin-bottom:10px;" id="errors_wrap">
            <strong class="danger">Corrija os campos para continuar:</strong>
            <ul id="errors_box" style="margin:8px 0 0 18px"></ul>
        </div>
        <form method="POST">
            <div class="grid">
                <div>
                    <label for="nivel">Nível</label>
                    <select name="nivel" required>
                        <option value="b2" {% if questao and questao.nivel == 'b2' %}selected{% endif %}>B2</option>
                        <option value="c1" {% if questao and questao.nivel == 'c1' %}selected{% endif %}>C1</option>
                    </select>
                </div>
                <div>
                    <label for="tipo">Tipo</label>
                    <select name="tipo" id="tipo" onchange="toggleAudioField()" required>
                        <option value="reading" {% if questao and questao.tipo == 'reading' %}selected{% endif %}>Reading</option>
                        <option value="grammar" {% if questao and questao.tipo == 'grammar' %}selected{% endif %}>Grammar</option>
                        <option value="use_of_english" {% if questao and questao.tipo == 'use_of_english' %}selected{% endif %}>Use of English</option>
                        <option value="listening" {% if questao and questao.tipo == 'listening' %}selected{% endif %}>Listening</option>
                    </select>
                </div>
            </div>

            <div id="audio_field" style="display: none;">
                <label for="audio">Link do Áudio</label>
                <input type="text" name="audio" value="{{ questao.audio if questao else '' }}" placeholder="https://..." />
                <div class="hint">Informe uma URL acessível (ex.: arquivo .mp3 ou link público).</div>
                <audio id="audio_preview" controls class="audio-preview" style="display:none;width:100%"></audio>
            </div>

            <label for="enunciado">Enunciado</label>
            <textarea id="enunciado" name="enunciado">{{ questao.enunciado|safe if questao else '' }}</textarea>

            <label>Alternativas</label>
            <div class="row">
                <div class="alt-label">A</div>
                <input type="text" name="A" value="{{ questao.alternativas.A if questao else '' }}" required>
                <label class="radio"><input type="radio" name="resposta" value="A" {% if questao and questao.resposta == 'A' %}checked{% endif %}> correta</label>
            </div>
            <div class="row">
                <div class="alt-label">B</div>
                <input type="text" name="B" value="{{ questao.alternativas.B if questao else '' }}" required>
                <label class="radio"><input type="radio" name="resposta" value="B" {% if questao and questao.resposta == 'B' %}checked{% endif %}> correta</label>
            </div>
            <div class="row">
                <div class="alt-label">C</div>
                <input type="text" name="C" value="{{ questao.alternativas.C if questao else '' }}" required>
                <label class="radio"><input type="radio" name="resposta" value="C" {% if questao and questao.resposta == 'C' %}checked{% endif %}> correta</label>
            </div>
            <div class="row">
                <div class="alt-label">D</div>
                <input type="text" name="D" value="{{ questao.alternativas.D if questao else '' }}" required>
                <label class="radio"><input type="radio" name="resposta" value="D" {% if questao and questao.resposta == 'D' %}checked{% endif %}> correta</label>
            </div>
            <div class="hint">Mantenha 4 alternativas distintas (A–D). A resposta selecionada será salva como correta.</div>

            <div class="actions">
                <button type="submit">{% if questao %}💾 Atualizar{% else %}💾 Salvar{% endif %}</button>
                <a href="{{ url_for('admin.listar_questoes') }}" class="btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</body>
</html>
